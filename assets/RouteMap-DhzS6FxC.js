import{r as k,D as z,A as E,e as J,O as S,Y as O,j as m,o as v}from"./index-CJMgYQ0G.js";import{c as R,l as G,d as _,e as T,M as B,B as D,a as I,b as P,L as d}from"./BaseTile-Zy4_3G0U.js";import{S as V,C as W}from"./CompassControl-CgGBunbt.js";import{d as q}from"./App-CN_8WmNx.js";import"./index-DJ_Y8GTM.js";const w=R(function({data:o,...r},g){const f=new G.GeoJSON(o,r);return _(f,T(g,{overlayContainer:f}))},function(o,r,g){r.style!==g.style&&(r.style==null?o.resetStyle():o.setStyle(r.style))}),H=(n,o)=>{const[r,g]=k.useState(null),{db:{routeList:f}}=k.useContext(z),{gtfsId:y,bound:b,co:M}=f[n];return k.useEffect(()=>{let C="";return y?C=`${y}-${b[M[0]]==="I"?"I":"O"}.json`:M.includes("mtr")&&(C=`${n.split("-")[0].toLowerCase()}.json`),fetch(`https://hkbus.github.io/route-waypoints/${C}`).then($=>$.json()).then($=>{g($)}).catch(()=>{g({features:[{type:"Feature",geometry:{type:"LineString",coordinates:o.reduce(($,{location:{lat:j,lng:i}})=>($.push([i,j]),$),[])}}],type:"FeatureCollection"})}),()=>{g(null)}},[n,y,b,M,o]),r},re=({routeId:n,stopIds:o,stopIdx:r,route:g,companies:f,onMarkerClick:y})=>{var p;const{geolocation:b,geoPermission:M,updateGeoPermission:C}=k.useContext(E),{db:{stopList:$}}=k.useContext(z),j=J(),[i,A]=k.useState(null),s=k.useMemo(()=>o.map(a=>$[a]),[$,o]),u=H(n,s),t=k.useRef({initialCenter:s[r]?s[r].location:S(),currentStopCenter:s[r]?s[r].location:S(),center:s[r]?s[r].location:S(),isFollow:!1,stops:s,stopIdx:r});k.useEffect(()=>{var L,N;let a,l;t.current.stops!==s||t.current.stopIdx!==r?a=!1:a=t.current.isFollow,t.current.stops===s&&t.current.stopIdx===r&&a?l=b.current:l=s[r]?s[r].location:S();const h=t.current.center;h!==l&&!O(l,h)&&(t.current.stops!==s?(L=t.current.map)==null||L.setView(l):(N=t.current.map)==null||N.flyTo(l)),t.current={...t.current,center:l,currentStopCenter:s[r]?s[r].location:S(),stops:s,stopIdx:r,isFollow:a}},[s,r,b]),k.useEffect(()=>{if(i){t.current={...t.current,map:i};const a=()=>{t.current={...t.current,center:t.current.currentStopCenter,isFollow:!1}};return i==null||i.on({dragend:a,dragstart:a}),i==null||i.setView(t.current.center),i==null||i.invalidateSize(),()=>{i.off({dragstart:a,dragend:a})}}},[i]);const x=k.useCallback(()=>{var a;M==="granted"?((a=t.current.map)==null||a.flyTo(b.current),t.current={...t.current,center:b.current,isFollow:!0}):M!=="denied"&&(t.current={...t.current,isFollow:!0},C("opening"))},[b,M,C]);return m.jsx(q,{id:"route-map",sx:Y,children:m.jsxs(B,{center:t.current.initialCenter,zoom:16,scrollWheelZoom:!1,className:e.mapContainer,ref:A,children:[m.jsx(D,{}),s.map((a,l)=>m.jsx(I,{position:a.location,icon:X({active:l===r,passed:l<r,companies:f}),alt:`${l}. ${a.name[j]}`,eventHandlers:{click:h=>{y(l,h)}}},`${a.location.lng}-${a.location.lat}-${l}`)),((p=u==null?void 0:u.features)==null?void 0:p.length)&&m.jsxs(m.Fragment,{children:[m.jsx(w,{data:u,style:F(f,g,!0)},u==null?void 0:u.timeStamp),m.jsx(w,{data:u,style:F(f,g,!1)},u==null?void 0:u.timeStamp)]}),m.jsx(V,{}),m.jsx(P,{onClick:x}),m.jsx(W,{})]})})},F=(n,o,r)=>function(){return{color:r?"#000000":v(n,o),weight:r?6:4,className:n.includes("ctb")&&n.includes("kmb")&&!r?e.jointlyLine:void 0}},X=({active:n,passed:o,companies:r})=>r[0]==="mtr"?d.divIcon({iconSize:[20,20],iconAnchor:[10,10],className:`${e.mtrMarker} ${e.marker} ${n?e.active:""} ${o?e.passed:""}`}):r.includes("lightRail")?d.divIcon({iconSize:[20,20],iconAnchor:[10,10],className:`${e.mtrMarker} ${e.marker} ${n?e.active:""} ${o?e.passed:""}`}):r[0].startsWith("gmb")?d.divIcon({iconSize:[30,30],iconAnchor:[15,30],className:`${e.gmbMarker} ${e.marker} ${n?e.active:""} ${o?e.passed:""}`}):r.includes("lrtfeeder")?d.divIcon({iconSize:[30,30],iconAnchor:[15,30],className:`${e.lrtfeederMarker} ${e.marker} ${n?e.active:""} ${o?e.passed:""}`}):r.includes("nlb")?d.divIcon({iconSize:[30,30],iconAnchor:[15,30],className:`${e.nlbMarker} ${e.marker} ${n?e.active:""} ${o?e.passed:""}`}):r.includes("ctb")&&r.includes("kmb")?d.divIcon({iconSize:[30,30],iconAnchor:[15,30],className:`${e.jointlyMarker} ${e.marker} ${n?e.active:""} ${o?e.passed:""}`}):r.includes("ctb")?d.divIcon({iconSize:[30,30],iconAnchor:[15,30],className:`${e.ctbMarker} ${e.marker} ${n?e.active:""} ${o?e.passed:""}`}):d.divIcon({iconSize:[30,30],iconAnchor:[15,30],className:`${e.kmbMarker} ${e.marker} ${n?e.active:""} ${o?e.passed:""}`}),c="map",e={mapContainerBox:`${c}-mapContainerBox`,mapContainer:`${c}-mapContainer`,centerControl:`${c}-centerControl`,marker:`${c}-marker`,mtrMarker:`${c}-mtrMarker`,gmbMarker:`${c}-gmbMarker`,ctbMarker:`${c}-ctbMarker`,jointlyMarker:`${c}-jointlyMarker`,lrtfeederMarker:`${c}-lrtfeederMarker`,nlbMarker:`${c}-nlbMarker`,kmbMarker:`${c}-kmbMarker`,jointlyLine:`${c}-jointlyLine`,active:`${c}-active`,passed:`${c}-passed`},Y={height:"35vh",filter:n=>n.palette.mode==="dark"?"brightness(0.8)":"none",[`& .${e.mapContainer}`]:{height:"35vh"},[`& .${e.mtrMarker}`]:{backgroundImage:"url(/img/mtr.svg)"},[`& .${e.gmbMarker}`]:{backgroundImage:"url(/img/minibus.svg)"},[`& .${e.ctbMarker}`]:{backgroundImage:"url(/img/bus_ctb.svg)"},[`& .${e.jointlyMarker}`]:{backgroundImage:"url(/img/bus_jointly.svg)"},[`& .${e.lrtfeederMarker}`]:{backgroundImage:"url(/img/bus_lrtfeeder.svg)"},[`& .${e.nlbMarker}`]:{backgroundImage:"url(/img/bus_nlb.svg)"},[`& .${e.kmbMarker}`]:{backgroundImage:"url(/img/bus_kmb.svg)"},[`& .${e.jointlyLine}`]:{stroke:v(["kmb"],""),animation:`${e.jointlyLine}-color 10s infinite linear 1.5s`},[`@keyframes ${e.jointlyLine}-color`]:{"50%":{stroke:v(["ctb"],"")},"100%":{stroke:v(["kmb"],"")}},[`& .${e.active}`]:{animation:"blinker 1.5s infinite"},[`& .${e.passed}`]:{filter:"grayscale(100%)"},"& .self-center":{backgroundImage:"url(/img/self.svg)",backgroundSize:"contain",backgroundRepeat:"no-repeat",backgroundPosition:"center",transition:"transform 0.1s ease-out",transformOrigin:"center"}};export{re as default};
